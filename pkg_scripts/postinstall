#!/bin/bash
set -euo pipefail

LOG_FILE="/tmp/FreenectTD_Installer.log"
exec > >(tee -a "$LOG_FILE") 2>&1

ls -l "$PWD"

# Variables

# Bundle name
BUNDLE_NAME="FreenectTOP.plugin"

# Currently logged-in user
USER_NAME=$(stat -f%Su /dev/console)
USER_HOME=$(dscl . -read /Users/$USER_NAME NFSHomeDirectory | awk '{print $2}')
echo "User=$USER_NAME, Home=$USER_HOME"

# Staging directory and source plugin path
STAGING_DIR="/tmp/FreenectTD-Installer"
PLUGIN_SRC="${STAGING_DIR}/${BUNDLE_NAME}"

# Final plugin destination
PLUGIN_DEST="${USER_HOME}/Library/Application Support/Derivative/TouchDesigner099/Plugins"

# Check if source plugin exists
if [ ! -d "$PLUGIN_SRC" ]; then
    echo "ERROR: Plugin not found at $PLUGIN_SRC"
    exit 1
fi

# Delete existing plugin if it exists
if [ -d "${PLUGIN_DEST}/Freenect*" ]; then
    rm -rf "${PLUGIN_DEST:?}/Freenect*"
fi

# Create destination directory if it doesn't exist
rm -rf "${PLUGIN_DEST}/${BUNDLE_NAME}"
mkdir -p "${PLUGIN_DEST}"
ditto "${PLUGIN_SRC}" "${PLUGIN_DEST}/${BUNDLE_NAME}"

# Chown to the user
chown -R "${USER_NAME}" "${PLUGIN_DEST}/${BUNDLE_NAME}"

# Set permissions
chmod -R 755 "${PLUGIN_DEST}/${BUNDLE_NAME}"

# Delete staging directory
rm -rf "${STAGING_DIR}"

exit 0
